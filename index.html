<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Lab</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
    
    <style>
        /* COLOR THEME */
        :root {
            --bg-color: #f9f9f9; 
            --text-color: #333;
            --header-bg: #4a148c; /* Deep Purple */
            --header-text: #ffffff;
            --card-bg: #ffffff; 
            --accent-color: #e91e63; /* Pink */
            --vibrant-blue: #03a9f4; 
            --shadow-light: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Dark Mode */
        body.dark-mode {
            --bg-color: #121212; 
            --text-color: #e0e0e0;
            --header-bg: #000000; 
            --header-text: #ffffff;
            --card-bg: #1e1e1e;
            --vibrant-blue: #4fc3f7;
            --shadow-light: 0 4px 6px rgba(255, 255, 255, 0.1);
        }

        body { font-family: 'Helvetica Neue', sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px; background-color: var(--header-bg); color: var(--header-text); box-shadow: var(--shadow-light); position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 1.5em; margin: 0; }
        .icon-btn { background: none; border: none; color: var(--header-text); font-size: 1.2em; margin-left: 15px; cursor: pointer; }
        
        /* Navigation Tabs */
        .tabs { display: flex; justify-content: center; background-color: var(--card-bg); border-bottom: 1px solid #eee; }
        .tab { padding: 10px 20px; cursor: pointer; color: var(--text-color); border-bottom: 3px solid transparent; transition: border-color 0.3s, color 0.3s; }
        .tab.active { border-color: var(--accent-color); color: var(--accent-color); font-weight: bold; }

        /* Main Content */
        .container { padding: 15px; }
        #productsContainer { display: flex; flex-wrap: wrap; gap: 15px; }
        .product-card { background-color: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow-light); overflow: hidden; width: calc(50% - 7.5px); display: flex; flex-direction: column; cursor: pointer; }
        .product-card img { width: 100%; height: 200px; object-fit: cover; }
        .p-info { padding: 10px; }
        .p-name { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .p-price { color: var(--accent-color); font-size: 1em; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: var(--card-bg); margin: 15% auto; padding: 20px; border-radius: 10px; width: 80%; max-width: 400px; box-shadow: var(--shadow-light); position: relative; }
        .close-btn { color: var(--text-color); float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-btn:hover, .close-btn:focus { color: var(--accent-color); text-decoration: none; cursor: pointer; }

        /* Form & Button Styles */
        input[type="text"], input[type="password"], input[type="number"] { width: 100%; padding: 10px; margin: 8px 0 15px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; background-color: var(--bg-color); color: var(--text-color); }
        .btn { background-color: var(--accent-color); color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; font-size: 1em; transition: background-color 0.3s; }
        .btn:hover:not(:disabled) { background-color: #c2185b; }
        .btn:disabled { background-color: #cccccc; cursor: not-allowed; }
        
        /* Product Details Modal */
        #detailsImage { width: 100%; height: 250px; object-fit: cover; border-radius: 8px; margin-bottom: 15px; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .detail-row label { font-weight: bold; }
        .detail-row select, .detail-row input { flex-grow: 1; margin-left: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; background-color: var(--bg-color); color: var(--text-color); }

        /* Snackbar/Toast */
        #snackbar { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 10000; left: 50%; transform: translateX(-50%); bottom: 30px; font-size: 17px; }
        #snackbar.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        #snackbar.error { background-color: #d32f2f; }
        #snackbar.success { background-color: #388e3c; }

        @-webkit-keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @-webkit-keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
        @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
        
        /* Language Toggle */
        #lang-select { padding: 5px; border-radius: 4px; background-color: var(--card-bg); color: var(--text-color); border: 1px solid #ccc; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Fashion Lab</h1>
        <div>
            <button id="authBtn" class="icon-btn" onclick="openModal('loginModal')">
                <i class="fas fa-user"></i>
            </button>
            <button id="cartBtn" class="icon-btn" onclick="openModal('cartModal')">
                <i class="fas fa-shopping-cart"></i> (<span id="cartCount">0</span>)
            </button>
            <button class="icon-btn" onclick="toggleDarkMode()">
                <i id="theme-icon" class="fas fa-moon"></i>
            </button>
            <select id="lang-select" onchange="setLanguage(this.value)">
                <option value="my">MM</option>
                <option value="en">EN</option>
                <option value="th">TH</option>
            </select>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('women')">Women</div>
        <div class="tab" onclick="switchTab('men')">Men</div>
    </div>

    <div class="container">
        <div class="menu-section active" id="women-menu">
            <h2>Women's Collection</h2>
        </div>
        <div class="menu-section" id="men-menu">
            <h2>Men's Collection</h2>
        </div>
        <input type="text" id="searchInput" placeholder="Search products..." onkeyup="searchProducts()">
        
        <div id="productsContainer">
            </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
            <h3 id="authTitle">Login / Register</h3>
            
            <label for="phoneInput"><span id="phoneLabel">Phone Number</span> (<span id="countryCode">+95</span>)</label>
            <input type="text" id="phoneInput" placeholder="eg: 9xxxxxxxxx" value="">

            <button id="sendOtpBtn" class="btn" onclick="sendOtp()">Send OTP</button>
            <p style="text-align: center; font-size: 0.8em; margin-top: 15px;"><span id="authInfo">A 6-digit OTP code will be sent via SMS.</span></p>
        </div>
    </div>

    <div id="otpModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('otpModal')">&times;</span>
            <h3>OTP Verification</h3>
            <p id="otpInfo">Enter the 6-digit code sent to your phone.</p>
            
            <label for="otpCodeInput">OTP Code</label>
            <input type="number" id="otpCodeInput" placeholder="eg: 123456" maxlength="6">

            <button id="verifyOtpBtn" class="btn" onclick="verifyOtp()">Verify Code</button>
            <button class="btn" onclick="sendOtp(true)" style="background-color: #555; margin-top: 10px;" id="resendOtpBtn">Resend OTP</button>
        </div>
    </div>

    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('detailsModal')">&times;</span>
            <img id="detailsImage" src="" alt="Product Image">
            <h3 id="detailsName">Product Name</h3>
            <p id="detailsPrice" style="color: var(--accent-color); font-size: 1.2em; font-weight: bold;"></p>
            
            <div class="detail-row">
                <label for="detailsColor">Color:</label>
                <select id="detailsColor" onchange="updateDetailsImage()"></select>
            </div>
            <div class="detail-row">
                <label for="detailsSize">Size:</label>
                <select id="detailsSize"></select>
            </div>
            <div class="detail-row">
                <label for="detailsQty">Quantity:</label>
                <input type="number" id="detailsQty" value="1" min="1" max="10">
            </div>
            
            <button id="addToCartBtn" class="btn" onclick="addToCart()">Add to Cart</button>
        </div>
    </div>
    
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('cartModal')">&times;</span>
            <h3>Shopping Cart</h3>
            <div id="cartItemsContainer">
                </div>
            <p style="font-weight: bold; border-top: 1px solid #ccc; padding-top: 10px;">Total: <span id="cartTotal">0</span> MMK</p>
            
            <h4>Shipping Information</h4>
            <label for="customerName">Name:</label>
            <input type="text" id="customerName">
            <label for="customerAddress">Address:</label>
            <input type="text" id="customerAddress">
            
            <button id="checkoutBtn" class="btn" onclick="sendOrder()">Place Order</button>
        </div>
    </div>
    
    <div id="snackbar"></div>

    <script>
        // =================================================================
        // 1. GLOBAL CONFIG & INITIALIZATION
        // =================================================================

        // !!! CHANGE THESE TO YOUR ACTUAL KEYS !!!
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; 
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        const BOT_TOKEN = 'YOUR_TELEGRAM_BOT_TOKEN'; 
        const CHAT_ID = 'YOUR_ADMIN_CHAT_ID'; // Admin's Telegram Chat ID

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentProducts = [];
        let currentUser = null;
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        
        let currentLanguage = localStorage.getItem('lang') || 'my';
        
        const translations = {
            my: {
                // Shared
                required_phone: "á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º á€–á€¼á€Šá€·á€ºá€•á€«á‹",
                sending_otp: "OTP á€•á€­á€¯á€·á€”á€±á€žá€Šá€º...",
                otp_sent: "OTP á€€á€¯á€’á€ºá€€á€­á€¯ á€•á€­á€¯á€·á€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹",
                required_otp_phone: "á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€ºá€”á€¾á€„á€·á€º OTP á€€á€¯á€’á€º á€–á€¼á€Šá€·á€ºá€•á€«á‹",
                verifying: "á€¡á€á€Šá€ºá€•á€¼á€¯á€”á€±á€žá€Šá€º...",
                verify: "á€¡á€á€Šá€ºá€•á€¼á€¯á€™á€Šá€º",
                login_success: "á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ á€á€„á€ºá€›á€±á€¬á€€á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®á‹",
                // Auth Modal
                phoneLabel: "á€–á€¯á€”á€ºá€¸á€”á€¶á€•á€«á€á€º",
                authTitle: "á€¡á€€á€±á€¬á€„á€·á€ºá€á€„á€º/á€¡á€€á€±á€¬á€„á€·á€ºá€–á€½á€„á€·á€º",
                authInfo: "á†-á€œá€¯á€¶á€¸á€•á€« OTP á€€á€¯á€’á€ºá€€á€­á€¯ SMS á€–á€¼á€„á€·á€º á€•á€­á€¯á€·á€•á€±á€¸á€•á€«á€™á€Šá€ºá‹",
                // Checkout
                place_order: "á€™á€¾á€¬á€šá€°á€™á€Šá€º",
                sending_order: "á€™á€¾á€¬á€šá€°á€™á€¾á€¯á€€á€­á€¯ á€•á€­á€¯á€·á€”á€±á€žá€Šá€º...",
                order_success: "á€™á€¾á€¬á€šá€°á€™á€¾á€¯ á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€•á€«á€žá€Šá€ºá‹ á€€á€»á€±á€¸á€‡á€°á€¸á€á€„á€ºá€•á€«á€á€šá€ºá‹",
                order_fail: "á€™á€¾á€¬á€šá€°á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸á€¡á€šá€½á€„á€ºá€¸á€›á€¾á€­á€•á€«á€žá€Šá€ºá‹"
            },
            en: {
                required_phone: "Please enter phone number.",
                sending_otp: "Sending OTP...",
                otp_sent: "OTP code has been sent.",
                required_otp_phone: "Please enter phone and OTP code.",
                verifying: "Verifying...",
                verify: "Verify Code",
                login_success: "Logged in successfully.",
                phoneLabel: "Phone Number",
                authTitle: "Login / Register",
                authInfo: "A 6-digit OTP code will be sent via SMS.",
                place_order: "Place Order",
                sending_order: "Sending Order...",
                order_success: "Order placed successfully! Thank you.",
                order_fail: "Order failed. Please try again."
            },
            th: {
                required_phone: "à¹‚à¸›à¸£à¸”à¹ƒà¸ªà¹ˆà¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ",
                sending_otp: "à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡à¸£à¸«à¸±à¸ª OTP...",
                otp_sent: "à¸ªà¹ˆà¸‡à¸£à¸«à¸±à¸ª OTP à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§",
                required_otp_phone: "à¹‚à¸›à¸£à¸”à¹ƒà¸ªà¹ˆà¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œà¹à¸¥à¸°à¸£à¸«à¸±à¸ª OTP",
                verifying: "à¸à¸³à¸¥à¸±à¸‡à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š...",
                verify: "à¸¢à¸·à¸™à¸¢à¸±à¸™à¸£à¸«à¸±à¸ª",
                login_success: "à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸šà¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§",
                phoneLabel: "à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ",
                authTitle: "à¹€à¸‚à¹‰à¸²à¸ªà¸¹à¹ˆà¸£à¸°à¸šà¸š / à¸¥à¸‡à¸—à¸°à¹€à¸šà¸µà¸¢à¸™",
                authInfo: "à¸£à¸«à¸±à¸ª OTP 6 à¸«à¸¥à¸±à¸ à¸ˆà¸°à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¸œà¹ˆà¸²à¸™ SMS.",
                place_order: "à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­à¸ªà¸´à¸™à¸„à¹‰à¸²",
                sending_order: "à¸à¸³à¸¥à¸±à¸‡à¸ªà¹ˆà¸‡à¸„à¸³à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­...",
                order_success: "à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§! à¸‚à¸­à¸šà¸„à¸¸à¸“à¸„à¸£à¸±à¸š/à¸„à¹ˆà¸°",
                order_fail: "à¸à¸²à¸£à¸ªà¸±à¹ˆà¸‡à¸‹à¸·à¹‰à¸­à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§"
            }
        };
        let currentTranslations = translations[currentLanguage];

        // =================================================================
        // 2. AUTHENTICATION FUNCTIONS (NATIVE PHONE OTP)
        // =================================================================
        
        // Helper to format phone number to +95 format (Assuming Myanmar context)
        function formatPhone(phone) {
            let cleanedPhone = phone.replace(/[^\d]/g, ''); 
            if (cleanedPhone.length >= 8 && !cleanedPhone.startsWith('95')) {
                 if (cleanedPhone.startsWith('9') && cleanedPhone.length > 8) {
                    cleanedPhone = '95' + cleanedPhone; // e.g., 9421234567 -> 959421234567
                 } else if (cleanedPhone.startsWith('09')) {
                     cleanedPhone = '95' + cleanedPhone.substring(1); // e.g., 09421234567 -> 959421234567
                 }
            }
            if (!cleanedPhone.startsWith('+')) {
                cleanedPhone = '+' + cleanedPhone;
            }
            // Supabase needs the full international format
            return cleanedPhone; 
        }

        // 2.1 Send OTP Code (Register/Login)
        async function sendOtp(resend = false) {
            const phoneInput = document.getElementById('phoneInput');
            const phone = phoneInput.value.trim();
            const btn = document.getElementById('sendOtpBtn');

            if (!phone) {
                showSnackbar(currentTranslations.required_phone, 'error');
                return;
            }
            
            const formattedPhone = formatPhone(phone);

            if (!resend) {
                btn.disabled = true;
                btn.innerText = currentTranslations.sending_otp; 
            } else {
                 document.getElementById('resendOtpBtn').disabled = true;
            }


            try {
                const { error } = await supabase.auth.signInWithOtp({
                    phone: formattedPhone
                });

                if (error) throw error;

                showSnackbar(currentTranslations.otp_sent, 'success'); 
                
                // Open OTP modal and save the phone number for verification
                openModal('otpModal'); 
                document.getElementById('otpModal').dataset.phone = formattedPhone;
                document.getElementById('otpInfo').innerText = `Enter the 6-digit code sent to ${formattedPhone}.`;

            } catch (error) {
                console.error('Error sending OTP:', error.message);
                showSnackbar(error.message, 'error');
            } finally {
                if (!resend) {
                    btn.disabled = false;
                    btn.innerText = 'Send OTP'; // Revert back to original text
                } else {
                    // Re-enable resend button after a cool-down period (e.g., 60s)
                    setTimeout(() => { document.getElementById('resendOtpBtn').disabled = false; }, 60000); 
                }
            }
        }

        // 2.2 Verify OTP Code
        async function verifyOtp() {
            const otpInput = document.getElementById('otpCodeInput');
            const otp = otpInput.value.trim();
            
            const phone = document.getElementById('otpModal').dataset.phone; 
            const btn = document.getElementById('verifyOtpBtn');

            if (!otp || !phone) {
                showSnackbar(currentTranslations.required_otp_phone, 'error');
                return;
            }

            btn.disabled = true;
            btn.innerText = currentTranslations.verifying; 

            try {
                const { data, error } = await supabase.auth.verifyOtp({
                    phone: phone,
                    token: otp,
                    type: 'sms' 
                });

                if (error) throw error;
                if (!data.user) throw new Error("Verification successful but user data is missing.");
                
                // 1. Success, close modals
                closeModal('otpModal');
                closeModal('loginModal');

                // 2. Save user data and update UI
                currentUser = data.user;
                await fetchOrCreateUserProfile(currentUser);
                updateLoginUI(currentUser); 
                
                showSnackbar(currentTranslations.login_success, 'success'); 

            } catch (error) {
                console.error('Error verifying OTP:', error.message);
                showSnackbar(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerText = currentTranslations.verify; 
            }
        }
        
        // 2.3 Handle Profile creation/fetching after successful Auth
        async function fetchOrCreateUserProfile(user) {
             const { data: profile, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', user.id)
                .single();

            if (error && error.code === 'PGRST116') { // RLS-related error (User not found)
                // User not found, create profile (Register logic)
                const { error: insertError } = await supabase
                    .from('users')
                    .insert([{ 
                        id: user.id, 
                        phone: user.phone, 
                        created_at: new Date().toISOString() 
                    }]);
                if (insertError) {
                    console.error("Error creating user profile:", insertError);
                    showSnackbar("Profile creation failed.", 'error');
                }
            } else if (error) {
                console.error("Error fetching profile:", error);
                showSnackbar("Error fetching user data.", 'error');
            }
        }

        // 2.4 Logout Function (Unchanged)
        async function doLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error);
                showSnackbar('Logout failed.', 'error');
            } else {
                currentUser = null;
                updateLoginUI(null);
                showSnackbar('Logged out successfully.', 'success');
            }
        }
        
        // 2.5 Update UI (Unchanged, but adapted for phone auth)
        function updateLoginUI(user) {
            const authBtn = document.getElementById('authBtn');
            const cartBtn = document.getElementById('cartBtn');

            if (user) {
                authBtn.innerHTML = `<i class="fas fa-sign-out-alt"></i>`;
                authBtn.onclick = doLogout;
                cartBtn.style.display = 'inline-block';
            } else {
                authBtn.innerHTML = `<i class="fas fa-user"></i>`;
                authBtn.onclick = () => openModal('loginModal');
                cartBtn.style.display = 'none'; // Hide cart if not logged in
            }
        }

        // =================================================================
        // 3. PRODUCT & ORDER FUNCTIONS (Mostly Unchanged)
        // =================================================================

        // 3.1 Fetch Products (Unchanged)
        async function fetchProducts() {
            const { data, error } = await supabase.from('products').select('*');
            if (error) {
                console.error('Error fetching products:', error);
                showSnackbar('Failed to load products.', 'error');
                return;
            }
            currentProducts = data;
            renderProducts(currentProducts);
        }

        // 3.2 Send Order (Telegram integration - USE CAUTION)
        async function sendOrder() {
            if (!currentUser || cart.length === 0) return;

            const name = document.getElementById('customerName').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            const checkoutBtn = document.getElementById('checkoutBtn');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (!name || !address) {
                showSnackbar("Please fill in Name and Address.", 'error');
                return;
            }

            checkoutBtn.disabled = true;
            checkoutBtn.innerText = currentTranslations.sending_order;

            try {
                // 1. Save Order to Database
                const { data: orderData, error: orderError } = await supabase
                    .from('orders')
                    .insert([{ 
                        user_id: currentUser.id,
                        customer_name: name,
                        shipping_address: address,
                        total_amount: total,
                        items: cart 
                    }])
                    .select()
                    .single();

                if (orderError) throw orderError;
                
                // 2. Send Telegram Notification (SECURITY RISK - SEE NOTES)
                const message = encodeURIComponent(
                    `*NEW ORDER ALERT (Order #${orderData.id})*\n` +
                    `--------------------------------------\n` +
                    `ðŸ‘¤ *Customer*: ${name} (Phone: ${currentUser.phone})\n` +
                    `ðŸ“ *Address*: ${address}\n` +
                    `ðŸ’° *Total*: ${total.toLocaleString()} MMK\n` +
                    `ðŸ›’ *Items*:\n` +
                    cart.map(i => `  - ${i.name} (${i.color}, ${i.size}) x ${i.quantity}`).join('\n')
                );

                await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${CHAT_ID}&text=${message}&parse_mode=Markdown`);

                // 3. Success
                cart = [];
                localStorage.removeItem('cart');
                updateCartUI();
                closeModal('cartModal');
                showSnackbar(currentTranslations.order_success, 'success');

            } catch (error) {
                console.error('Order sending failed:', error);
                showSnackbar(currentTranslations.order_fail, 'error');
            } finally {
                checkoutBtn.disabled = false;
                checkoutBtn.innerText = currentTranslations.place_order;
            }
        }
        
        // =================================================================
        // 4. UI/HELPER FUNCTIONS (Mostly Unchanged)
        // =================================================================

        // 4.1 Snackbar (Unchanged)
        let snackbarTimeout;
        function showSnackbar(message, type = 'info') {
            const snackbar = document.getElementById('snackbar');
            clearTimeout(snackbarTimeout);
            
            snackbar.innerText = message;
            snackbar.className = `show ${type}`; 

            snackbarTimeout = setTimeout(() => { snackbar.className = snackbar.className.replace("show", ""); }, 3000);
        }

        // 4.2 Modal Handlers (Unchanged)
        function openModal(id) { document.getElementById(id).style.display='block'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        
        // 4.3 Language Setting (Unchanged)
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('lang', lang);
            currentTranslations = translations[lang];
            // Reload content/text here
            document.getElementById('lang-select').value = lang;
            document.getElementById('phoneLabel').innerText = currentTranslations.phoneLabel;
            document.getElementById('authTitle').innerText = currentTranslations.authTitle;
            document.getElementById('authInfo').innerText = currentTranslations.authInfo;
            document.getElementById('sendOtpBtn').innerText = 'Send OTP'; // Default text after change
            document.getElementById('checkoutBtn').innerText = currentTranslations.place_order;
            document.getElementById('verifyOtpBtn').innerText = currentTranslations.verify;
        }

        // 4.4 Dark Mode (Unchanged)
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark);
            document.getElementById('theme-icon').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        // 4.5 Other UI functions (renderProducts, openDetails, addToCart, updateCartUI, searchProducts, switchTab) 
        // -> (These functions are assumed to be present and unchanged from your original code, 
        //     or they need to be fully implemented based on your original structure)
        
        // Example Placeholder for renderProducts (You need to use your actual logic here)
        function renderProducts(products) {
            const container = document.getElementById('productsContainer');
            container.innerHTML = products.map(p => `
                <div class="product-card" onclick="openDetails(${p.id})">
                    <img src="${p.main_image}" alt="${p.name}" loading="lazy">
                    <div class="p-info">
                        <div class="p-name">${p.name}</div>
                        <div class="p-price">${p.price.toLocaleString()} MMK</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Example Placeholder for updateCartUI
        function updateCartUI() {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').innerText = count;
            // You should also update cartItemsContainer and cartTotal here
        }

        // =================================================================
        // 5. INITIAL SETUP
        // =================================================================
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Load Dark Mode State
            if (localStorage.getItem('darkMode') === 'true') {
                toggleDarkMode(); // Toggle once to set state and icon
            } else {
                document.getElementById('theme-icon').className = 'fas fa-moon'; // Default light
            }

            // Load Language
            setLanguage(currentLanguage);

            // Fetch initial products
            await fetchProducts();
            
            // Check for existing session
            const { data: { user } } = await supabase.auth.getUser();
            currentUser = user;
            if (currentUser) {
                await fetchOrCreateUserProfile(currentUser);
            }
            updateLoginUI(currentUser);
            updateCartUI(); // Initial cart count
        });

    </script>
</body>
</html>
