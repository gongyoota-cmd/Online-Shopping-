<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K Online Shopping</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
    
    <style>
        :root {
            --bg-color: #ffffff; --text-color: #333;
            --header-bg: #2d2d2d; --header-text: #ffffff;
            --card-bg: #ffffff; --accent-color: #d32f2f;
        }
        body { font-family: 'Helvetica Neue', sans-serif; margin: 0; padding: 0; background: #f5f5f5; color: var(--text-color); }
        
        /* HEADER */
        header { background: var(--header-bg); color: var(--header-text); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .nav-icons i { font-size: 20px; margin-left: 20px; cursor: pointer; }

        /* MENU (X ·Äñ·Äº·ÄØ·Äê·Ä∫·Äë·Ä¨·Ä∏·Äû·Ää·Ä∫) */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 150; }
        .overlay.active { display: block; }
        .side-menu { height: 100%; width: 280px; position: fixed; top: 0; left: -280px; background: white; transition: left 0.3s; z-index: 200; display: flex; flex-direction: column; }
        .side-menu.active { left: 0; }
        .menu-header { padding: 20px; background: #f4f4f4; font-weight: bold; font-size: 18px; }
        .menu-item { padding: 15px 20px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        
        /* PRODUCTS */
        .main-content { padding: 15px; padding-bottom: 80px; }
        .section-title { font-size: 18px; font-weight: bold; margin: 20px 0 10px 0; display: flex; justify-content: space-between; }
        
        .slider-container { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* ·ÅÇ ·ÄÄ·Ä±·Ä¨·Ä∫·Äú·Ä∂ */
            gap: 10px;
        }

        .product-card { 
            background: white; border-radius: 8px; overflow: hidden; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; 
        }
        .p-img { width: 100%; height: 200px; object-fit: cover; background: #eee; }
        .p-info { padding: 10px; }
        .p-name { font-size: 13px; height: 36px; overflow: hidden; margin-bottom: 5px; }
        .p-price { font-weight: bold; font-size: 14px; color: #333; }
        
        /* CART ICON (·Äà·Ä±·Ä∏·Äù·Äö·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏·Äê·Ä±·Ä¨·ÄÑ·Ä∫·Ä∏) */
        .cart-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--header-bg);
            color: white;
            width: 35px; height: 35px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .cart-btn:active { transform: scale(0.9); }

        /* CHECKOUT POPUP */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 400px; border-radius: 10px; padding: 20px;
            max-height: 90vh; overflow-y: auto; position: relative;
        }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }
        
        /* Payment Styles */
        .pay-row { display: flex; align-items: center; margin-bottom: 10px; padding: 10px; background: #f9f9f9; border-radius: 5px; }
        .pay-icon { width: 40px; height: 40px; border-radius: 5px; margin-right: 10px; object-fit: contain; background: white; border: 1px solid #eee;}
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        
        .order-btn {
            width: 100%; padding: 12px; background: #2d2d2d; color: white; border: none;
            border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer;
        }
        .order-btn:disabled { background: #ccc; }

    </style>
</head>
<body>

    <div class="overlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">Categories</div>
        <div class="menu-item" onclick="loadProducts('all', 'All Products')">All Products <i class="fas fa-chevron-right"></i></div>
        <div class="menu-item" onclick="loadProducts('clothing', 'Clothing')">Clothing <i class="fas fa-chevron-right"></i></div>
        <div class="menu-item" onclick="loadProducts('shoes', 'Shoes')">Shoes <i class="fas fa-chevron-right"></i></div>
        <div class="menu-item" onclick="loadProducts('bag', 'Bags')">Bags <i class="fas fa-chevron-right"></i></div>
    </div>

    <header>
        <div onclick="toggleMenu()"><i class="fas fa-bars"></i></div>
        <div style="font-weight:bold; font-size: 18px;">K Online Shopping</div>
        <div class="nav-icons"><i class="fas fa-shopping-bag"></i></div>
    </header>

    <div class="main-content">
        <div class="section-title" id="pageTitle">The Party Preview</div>
        <div id="loading" style="text-align:center; padding:20px; display:none;">Loading...</div>
        <div class="slider-container" id="productsContainer">
            </div>
    </div>

    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="close-modal" onclick="closeModal()">&times;</div>
            <h3 style="margin-top:0;">Order Form</h3>
            
            <div style="display:flex; gap:10px; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #eee;">
                <img id="modal-img" src="" style="width:60px; height:60px; object-fit:cover; border-radius:5px;">
                <div>
                    <div id="modal-name" style="font-weight:bold; font-size:14px;">Product Name</div>
                    <div id="modal-price" style="color:#d32f2f;">0 Ks</div>
                </div>
            </div>

            <div class="pay-row">
                <img src="https://play-lh.googleusercontent.com/cnkjYzzHgaeucXGsXHvxTJSyY9vukH9WkI8TjZ1kO2g2Qx-dcfN8oDq8vJ5bQ_hG1Q=w240-h480-rw" class="pay-icon">
                <div>
                    <div style="font-weight:bold; font-size:13px;">KPay</div>
                    <div style="font-size:12px;">09752965423 (Ko Ko)</div>
                </div>
            </div>
            <div class="pay-row">
                <img src="https://play-lh.googleusercontent.com/r9M5g2I4D_tWq2h9C-m2u92F0p5J1x5Z3j3g_q9g_w9k7x9v5n_r3l_x1z9j_q2w3e4=w240-h480-rw" class="pay-icon">
                <div>
                    <div style="font-weight:bold; font-size:13px;">Wave Money</div>
                    <div style="font-size:12px;">09752965423 (Ko Ko)</div>
                </div>
            </div>

            <div class="input-group">
                <label>Name (·Äî·Ä¨·Äô·Ää·Ä∫)</label>
                <input type="text" id="userName" placeholder="·Äû·ÄÑ·Ä∑·Ä∫·Äî·Ä¨·Äô·Ää·Ä∫·Äë·Ää·Ä∑·Ä∫·Äï·Ä´">
            </div>
            <div class="input-group">
                <label>Phone (·Äñ·ÄØ·Äî·Ä∫·Ä∏·Äî·Ä∂·Äï·Ä´·Äê·Ä∫)</label>
                <input type="tel" id="userPhone" placeholder="09xxxxxxxxx">
            </div>
            
            <div class="input-group">
                <label>Payment Slip (·ÄÑ·ÄΩ·Ä±·Äú·ÄΩ·Äæ·Ä≤·Äï·Äº·Ä±·ÄÖ·Ä¨ ·Äê·ÄÑ·Ä∫·Äõ·Äî·Ä∫)</label>
                <div style="border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 5px; cursor: pointer;" onclick="document.getElementById('slipInput').click()">
                    <i class="fas fa-camera" style="font-size: 20px; color: #888;"></i><br>
                    <span style="font-size:12px; color:#888;">Click to upload photo</span>
                </div>
                <input type="file" id="slipInput" accept="image/*" style="display:none" onchange="previewSlip()">
                <img id="slipPreview" src="" style="width:100%; margin-top:10px; border-radius:5px; display:none;">
            </div>

            <button class="order-btn" id="sendBtn" onclick="sendOrder()">Admin ·Äë·Ä∂·Äû·Ä≠·ÄØ·Ä∑ ·Äï·Ä≠·ÄØ·Ä∑·Äô·Ää·Ä∫</button>
            <p id="statusMsg" style="text-align:center; font-size:12px; margin-top:10px;"></p>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://hfsvxmnhoylhzbzvamiq.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhmc3Z4bW5ob3lsaHpienZhbWlxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjIzNzEsImV4cCI6MjA3OTEzODM3MX0.J37qWQaKqecVsmGWWj63CyClVDup6KAD24iZVjIIL-0'; 
        
        // TELEGRAM SETUP
        const BOT_TOKEN = '8180483853:AAGU6BHy2Ws-PboyopehdBFkWY5kpedJn6Y'; 
        // üëáüëáüëá ·Äí·ÄÆ·Äî·Ä±·Äõ·Ä¨·Äô·Äæ·Ä¨ ·ÄÄ·Ä≠·ÄØ·ÄÄ·Ä≠·ÄØ·Ä∑ Group ID ·Äë·Ää·Ä∑·Ä∫·Äõ·Äï·Ä´·Äô·Äö·Ä∫ (·Äô·Äë·Ää·Ä∑·Ä∫·Äõ·Äû·Ä±·Ä∏·Äõ·ÄÑ·Ä∫ Error ·Äï·Äº·Äï·Ä´·Äô·Äö·Ä∫)
        const CHAT_ID = 'YOUR_CHAT_ID_HERE'; 

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- SOUND ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playClickSound() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.05);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
            osc.start(); osc.stop(audioCtx.currentTime + 0.05);
        }
        document.addEventListener('click', (e) => { 
            if(!e.target.closest('input')) playClickSound(); 
        });

        // --- PRODUCTS LOGIC ---
        async function loadProducts(category, title) {
            document.getElementById('pageTitle').innerText = title;
            document.getElementById('sideMenu').classList.remove('active');
            document.querySelector('.overlay').classList.remove('active');
            
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            document.getElementById('loading').style.display = 'block';

            let query = supabaseClient.from('products').select('*');
            if (category !== 'all') query = query.eq('category', category);

            let { data: products, error } = await query;
            document.getElementById('loading').style.display = 'none';

            if (!products || products.length === 0) {
                container.innerHTML = `<p style="grid-column:1/-1; text-align:center;">No items found.</p>`;
                return;
            }

            let html = '';
            products.forEach(p => {
                const price = p.price ? Number(p.price).toLocaleString() : '0';
                const img = p.image_url ? p.image_url : 'https://via.placeholder.com/300';
                // escape quotes for onclick
                const safeName = p.name.replace(/'/g, "\\'"); 
                const safeImg = img.replace(/'/g, "\\'");
                
                html += `
                    <div class="product-card">
                        <img src="${img}" class="p-img">
                        <div class="p-info">
                            <div class="p-name">${p.name}</div>
                            <div class="p-price">${price} Ks</div>
                        </div>
                        <div class="cart-btn" onclick="openCart('${safeName}', '${price}', '${safeImg}')">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        // --- CART & TELEGRAM LOGIC ---
        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function openCart(name, price, img) {
            document.getElementById('modal-name').innerText = name;
            document.getElementById('modal-price').innerText = price + " Ks";
            document.getElementById('modal-img').src = img;
            document.getElementById('checkoutModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('checkoutModal').style.display = 'none';
        }

        function previewSlip() {
            const file = document.getElementById('slipInput').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('slipPreview').src = e.target.result;
                    document.getElementById('slipPreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        async function sendOrder() {
            if (CHAT_ID === 'YOUR_CHAT_ID_HERE') {
                alert("Please set your TELEGRAM GROUP ID in the code first!");
                return;
            }

            const name = document.getElementById('userName').value;
            const phone = document.getElementById('userPhone').value;
            const fileInput = document.getElementById('slipInput');
            const btn = document.getElementById('sendBtn');
            const status = document.getElementById('statusMsg');

            if (!name || !phone || !fileInput.files[0]) {
                alert("·ÄÄ·Äª·Ä±·Ä∏·Äá·Ä∞·Ä∏·Äï·Äº·ÄØ·Åç ·Ä°·ÄÅ·Äª·ÄÄ·Ä∫·Ä°·Äú·ÄÄ·Ä∫·Äô·Äª·Ä¨·Ä∏ ·Äï·Äº·Ää·Ä∑·Ä∫·ÄÖ·ÄØ·Ä∂·ÄÖ·ÄΩ·Ä¨·Äñ·Äº·Ää·Ä∑·Ä∫·Äï·Ä´ (Slip ·Äï·ÄØ·Ä∂·Äï·Ä´ ·Äë·Ää·Ä∑·Ä∫·Äï·Ä´)");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Sending...";
            status.innerText = "Telegram ·Äû·Ä≠·ÄØ·Ä∑ ·Äï·Ä≠·ÄØ·Ä∑·Äî·Ä±·Äï·Ä´·Äû·Ää·Ä∫...";

            // Prepare Message
            const productName = document.getElementById('modal-name').innerText;
            const productPrice = document.getElementById('modal-price').innerText;
            
            const caption = `
üõçÔ∏è *New Order Received!*
----------------------
üë§ Name: ${name}
üìû Phone: ${phone}
üëó Item: ${productName}
üí∞ Price: ${productPrice}
----------------------
‚úÖ Payment Slip Attached.
            `;

            // Send to Telegram (FormData for Image)
            const formData = new FormData();
            formData.append("chat_id", CHAT_ID);
            formData.append("photo", fileInput.files[0]);
            formData.append("caption", caption);
            formData.append("parse_mode", "Markdown");

            try {
                const response = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    alert("·Ä°·Ä±·Ä¨·Ä∫·Äí·Ä´·Äê·ÄÑ·Ä∫·ÄÅ·Äº·ÄÑ·Ä∫·Ä∏ ·Ä°·Ä±·Ä¨·ÄÑ·Ä∫·Äô·Äº·ÄÑ·Ä∫·Äï·Ä´·Äû·Ää·Ä∫! Admin ·ÄÜ·ÄÆ·Äû·Ä≠·ÄØ·Ä∑ ·Äõ·Ä±·Ä¨·ÄÄ·Ä∫·Äõ·Äæ·Ä≠·Äû·ÄΩ·Ä¨·Ä∏·Äï·Ä´·Äï·Äº·ÄÆ·Åã");
                    closeModal();
                    // Reset form
                    document.getElementById('userName').value = '';
                    document.getElementById('userPhone').value = '';
                    document.getElementById('slipInput').value = '';
                    document.getElementById('slipPreview').style.display = 'none';
                } else {
                    alert("Error sending to Telegram: " + result.description);
                }
            } catch (error) {
                alert("Network Error: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "Admin ·Äë·Ä∂·Äû·Ä≠·ÄØ·Ä∑ ·Äï·Ä≠·ÄØ·Ä∑·Äô·Ää·Ä∫";
                status.innerText = "";
            }
        }

        // Initial Load
        loadProducts('all', 'The Party Preview');

    </script>
</body>
</html>
